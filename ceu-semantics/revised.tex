\documentclass[11pt,a4paper,oneside,leqno]{article}
%- Packages -%
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{textcomp}
\usepackage[protrusion=true,expansion]{microtype}
\usepackage{hyperref}
\hypersetup{colorlinks=true,linkcolor=blue}%
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage[varg]{txfonts}
\usepackage{mathtools}
\usepackage[nameinlink]{cleveref}
%-
\newcommand{\MARK}[1]{\textcolor{red}{#1}}
\newcommand{\TODO}[1]{\textcolor{red}{[TODO: #1]}}
\newcommand{\FIXME}[1]{\textcolor{red}{[FIXME: #1]}}
\usepackage[textwidth=3.7cm,textsize=scriptsize,shadow]{todonotes}
\setlength{\marginparwidth}{3.7cm}
%-
\usepackage{enumitem}
\setlist{noitemsep}
\setlist[enumerate]{label=(\roman*)}
\newlist{case}{enumerate}{2}
\setlist[case]{itemsep=\topsep}
\setlist[case,1]{label=[Case~\arabic{casei}],ref=\arabic{casei},
  leftmargin=0pt,itemindent=*}
\setlist[case,2]{label=[Case~\arabic{casei}.\arabic{caseii}],
  ref=\arabic{casei}.\arabic{caseii},
  leftmargin=\parindent,itemindent=*,labelindent=\parindent}
\crefname{casei}{case}{cases}
\Crefname{casei}{Case}{Cases}
\crefname{caseii}{case}{cases}
\Crefname{caseii}{Case}{Cases}
%-
\usepackage{bussproofs}
\def\labelSpacing{0em}
\def\ScoreOverhang{0em}
\def\defaultHypSeparation{\quad}
\EnableBpAbbreviations
%- Theorems -%
\numberwithin{equation}{section}
\usepackage{thmtools}
\declaretheorem[
  name=Theorem,
  refname={theorem,theorems},
  Refname={Theorem,Theorems},
  numberwithin=section,
  style=plain,
  ]{theorem}
\declaretheorem[
  name=Lemma,
  refname={lemma,lemmas},
  Refname={Lemma,Lemmas},
  sharenumber=theorem,
  style=plain,
  ]{lemma}
\declaretheorem[
  name=Proposition,
  refname={proposition,propositions},
  refname={Proposition,Propositions},
  sharenumber=theorem,
  style=plain,
  ]{proposition}
\declaretheorem[
  name=Fallacy,
  refname={fallacy,fallacies},
  Refname={Fallacy,Fallacies},
  numbered=no,
  style=plain,
  ]{fallacy}
\declaretheorem[
  name=Convention,
  refname={convention,conventions},
  Refname={Convention,Conventions},
  numbered=no,
  style=definition,
  ]{convention}
\declaretheorem[
  name=Definition,
  refname={definition,definitions},
  Refname={Definition,Definitions},
  sharenumber=theorem,
  style=definition,
  ]{definition}
\declaretheorem[
  name=Notation,
  refname={notation,notations},
  Refname={Notation,Notations},
  numbered=no,
  style=remark,
  ]{notation}
\declaretheorem[
  name=Example,
  refname={example,examples},
  Refname={Example,Exemples},
  numbered=no,
  style=remark,
  ]{example}
%- Symbols -%
\def\Ceu{C\'eu}
\let\nil=\varepsilon
\def\<#1>{\langle#1\rangle}
\def\|#1|{\left|#1\right|}
\def\eval{\mathit{eval}}
\def\blocked{\mathit{blocked}}
\def\clear{\mathit{clear}}
\makeatletter
\def\@raise#1#2#3{
  \setbox0=\hbox{#1}%
  \mathbin{%
    \hbox to\wd0{%
      \rlap{\box0}\hfill\raise#2\hbox{$\scriptstyle{#3}$}\hfill
    }%
  }%
}
\def\step#1{\@raise{$\to$}{1.1ex}{#1}}
\def\stepx#1{\@raise{$\step{#1}$}{-.75ex}{\ast}}
\def\ostep#1{\@raise{$\Rightarrow$}{1.1ex}{#1}}
\def\ostepx#1{\@raise{$\ostep{#1}$}{-.75ex}{\ast}}
\def\react#1{\@raise{$\vDash$}{1.3ex}{#1}}
\makeatother
%-
\makeatletter
\def\@ceuop#1{\mathop{\texttt{#1}}}%
\def\@ceubin#1{\mathbin{\texttt{#1}}}%
\def\ceu{\protect\@ceu}
\def\@ceu#1{%
  \bgroup
  \def\Skip{\@ceuop{skip}}%
  \def\Mem{\@ceuop{mem}}%
  \def\Attr##1##2{##1\coloneqq##2}%
  \def\AwaitExt{\@ceuop{awaitext}}%
  \def\Await{\@ceuop{await}}%
  \def\Emit{\@ceuop{emit}}%
  \def\Break{\@ceuop{break}}%
  \def\Ifelse##1##2##3{\@ceuop{if}##1\@ceuop{then}{##2}\@ceuop{else}{##3}}%
  \def\Loop{\@ceuop{loop}}%
  \def\And{\@ceubin{and}}%
  \def\Or{\@ceubin{or}}%
  \def\Fin{\@ceuop{fin}}%
  \def\AwaitingExt{\@ceuop{@awaitingext}}%
  \def\Awaiting{\@ceuop{@awaiting}}%
  \def\Emitting{\@ceuop{@emitting}}%
  \def\Atloop{\@ceuop{@loop}}%
  \def\Final{\@ceuop{halt}}%
  \def\True{\@ceuop{$\top$}}%
  \def\False{\@ceuop{$\bot$}}%
  \ensuremath{#1}\ignorespaces
  \egroup
}
\makeatother

\title{Determinism and termination in the semantics
  of the Céu programming language}
\begin{document}
\maketitle


\section{The original formulation}
\label{sec:orig}

The semantics discussed in this section follows as much as possible the
original semantics of \Ceu\ presented in~\cite{?}.  Any deviations from
original definitions are duly noted in the text.


\subsection{Abstract syntax}
\label{sub:orig:syntax}

The \emph{abstract syntax} of \Ceu\ programs is given by the following
grammar:
%%
\todo{%
  (1)~$\ceu{\protect\Skip}$ precisa aparecer na gramática já que
  aprece nos programas em~$P$.\newline
  %%
  (2)~Atribuição agora aparece explicitamente na gramática.  Expressões
  aritméticas e booleanas também estão na gramática mas a sua estrutura
  interna é omitida.}
%%
\bgroup
\vskip\abovedisplayskip
\noindent
\hfil\hbox{%
  \vtop{%
    \tabskip0pt
    \offinterlineskip
    \halign{\strut\hfil$#$&$\;#$\hfil&\qquad#\hfil\cr
      p\in{P}\Coloneqq
          & \MARK{\ceu{\Skip}}          & do nothing\cr
      \mid& \MARK{\ceu{\Attr{v}{a}}}    & assignment\cr
      \mid& \ceu{\Await(e)}             & await event\cr
      \mid& \ceu{\Emit(e)}              & emit event\cr
      \mid& \ceu{\Break}                & break innermost loop\cr
      \mid& \ceu{\Ifelse{b}{p_1}{p_2}}  & conditional\cr
      \mid& \ceu{p_1;p_2}               & sequence\cr
      \mid& \ceu{\Loop p_1}             & repetition\cr
      \mid& \ceu{p_1\And p_2}           & par/and\cr
      \mid& \ceu{p_1\Or p_2}            & par/or\cr
      \mid& \ceu{\Fin p_1}              & finalization\cr
      \mid& \ceu{\Awaiting(e,n)}        & awaiting~$e$ since reaction~$n$\cr
      \mid& \ceu{\Emitting(e,n)}        & emitting~$e$ on stack level~$n$\cr
      \mid& \ceu{p_1\Atloop p_2}        & unwinded loop\cr
    }%
  }%
}\hfil%
\vskip\belowdisplayskip
\egroup
%%
\noindent
where~$n\in{N}$ is an integer, $v\in{V}$~is a memory location (variable)
identifier, $e\in{E}$~is an event identifier, $a\in{A}$~is an arithmetic
expression, $b\in{B}$ is a boolean expression, and~$p$, $p_1$, $p_2\in{P}$
are programs.  We assume the usual structure for arithmetic and boolean
expressions, and omit their definition.


\subsection{The reaction inner-step relation}
\label{sub:orig:inner}

The \emph{state} of a \Ceu\ program within a reaction is represented by a
stack of events~$\alpha=e_1e_2\dots{e_n}\in{E}^*$ together with a memory
map~$m\colon{v}\to{N}\in\mathcal{M}$.  A \emph{configuration} is a
4-tuple~$\<p,\alpha,m,n>\in\Delta$ that represents the situation of
program~$p$ waiting to be evaluated in state~$\<\alpha,m>$ and reaction~$n$.
Given an initial configuration, each small-step within a program reaction is
determined by the reaction-inner-step
relation~$\mathord{\step{}}\in\Delta\times\Delta$ such
that~$\<p,\alpha,m,n>\step{}\<p',\alpha',m',n>$ iff a reaction inner-step of
program~$p$ in state~$\<\alpha,m>$ and reaction number~$n$ evaluates to a
modified program~$p'$ and a modified state~$\<\alpha',m'>$ in the same
reaction~($n$).  Since relation~$\step{}$ can only relate configurations
with the same~$n$, we shall write $\<p,\alpha,m>\step{n}\<p',\alpha',m'>$
for~$\<p,\alpha,m,n>\step{}\<p',\alpha',m',n>$.

Relation~$\step{}$ is defined inductively with the help of the auxiliary
functions~$\eval$, $\blocked$, and~$\clear$.  The~$\eval$ function evaluates
arithmetic or boolean expressions on a given memory; we omit its definition
and assume that such evaluation is deterministic and always terminates.
The~$\blocked$ function is a predicate that determines if all trails of a
program~$p$ are blocked on a given event stack and reaction number.  And
the~$\clear$ function extracts the body of~$\ceu{\Fin}$ blocks from a given
program.

\begin{definition}[label={def:orig:blocked}]
  Function~$\blocked\colon{P\times{E^*}\times{N}}\to\{0,1\}$ is defined
  inductively as follows.
  \begin{align*}
    \MARK{\blocked(\ceu{\Skip},e\alpha,n)}
    &\MARK{=0}\\
    %%
    \blocked(\ceu{\Attr{v}{a}},e\alpha,n)
    &=0\\
    %%
    \blocked(\ceu{\Await(e')},e\alpha,n)
    &=0\\
    %%
    \blocked(\ceu{\Emit(e')},e\alpha,n)
    &=0\\
    %%
    \blocked(\ceu{\Break},e\alpha,n)
    &=0\\
    %%
    \blocked(\ceu{\Ifelse{b}{p_1}{p_2}},e\alpha,n)
    &=0\\
    %%
    \blocked(\ceu{p_1;p_2},e\alpha,n)
    &=\blocked(p_1,e\alpha,n)\\
    %%
    \blocked(\ceu{\Loop p},e\alpha,n)
    &=0\\
    %%
    \blocked(\ceu{p_1\And p_2},e\alpha,n)
    &=\blocked(p_1,e\alpha,n)\cdot\blocked(p_2,e\alpha,n)\\
    %%
    \blocked(\ceu{p_1\Or p_2},e\alpha,n)
    &=\blocked(p_1,e\alpha,n)\cdot\blocked(p_2,e\alpha,n)\\
    %%
    \blocked(\ceu{\Fin p_1},e\alpha,n)
    &=0\\
    % %%
    \blocked(\ceu{\Awaiting(e',n')},e\alpha,n)
    &=
      \begin{cases}
        1 &\text{if~$e\ne{e'}$ or~$n=n'$}\\
        0 &\text{otherwise}
      \end{cases}\\
    %%
    \blocked(\ceu{\Emitting(n')},e\alpha,n)
    &=
      \begin{cases}
        1 &\text{if~}\|e\alpha|\ne{n'}\\
        0 &\text{otherwise}
      \end{cases}\\
    %%
    \blocked(\ceu{p_1\Atloop p_2},e\alpha,n)
    &=\blocked(p_1,e\alpha,n)
  \end{align*}
\end{definition}

\begin{definition}[label={def:orig:clear}]
  Function $\clear\colon{P}\to{P'}$, \MARK{where
    $P'=\{\ceu{\Attr{v}{a}}\}$}, is defined inductively as follows.
  %%
  \todo{(1)~Além de atribuições~$P'$ não deveria conter instruções
    if-else?.\newline
    %%
    (2)~No artigo original, $\clear(p_1;p_2)$ retorna
    apenas~$\clear(p_1)$.  Achamos que isso está errado, já que apenas o
    primeiro~$\ceu{\protect\Fin}$ seria considerado.  (Confirmar com o
    Chicão).}
  %%
\begin{align*}
    \clear(\ceu{\Attr{v}{a}})
    &=\ceu{\MARK{\Attr{v}{a}}}\\
    %%
    \clear(\ceu{\Await(e')})
    &=\ceu{\Skip}\\
    %%
    \clear(\ceu{\Emit(e')})
    &=\ceu{\Skip}\\
    %%
    \clear(\ceu{\Break})
    &=\ceu{\Skip}\\
    %%
    \clear(\ceu{\Ifelse{v}{p_1}{p_2}})
    &=\ceu{\Skip}\\
    %%
    \clear(\ceu{p_1;p_2})
    &=\clear(p_1);\MARK{\clear(p_2)}\\
    %%
    \clear(\ceu{\Loop p})
    &=\clear(p)\\
    %%
    \clear(\ceu{p_1\And p_2})
    &=\clear(p_1);\clear(p_2)\\
    %%
    \clear(\ceu{p_1\Or p_2})
    &=\clear(p_1);\clear(p_2)\\
    %%
    \clear(\ceu{\Fin p})
    &=p\\
    % %%
    \clear(\ceu{\Awaiting(e',n')})
    &=\ceu{\Skip}\\
    %%
    \clear(\ceu{\Emitting(n')})
    &=\ceu{\Skip}\\
    %%
    \clear(\ceu{p_1\Atloop p_2})
    &=\clear(p_1)
  \end{align*}
\end{definition}

\begin{definition}[label={def:orig:inner-step},name={Reaction inner-step}]
  Relation~$\step{\null}\subseteq\Delta\times\Delta$ is defined inductively
  as follows.
  %%
  \todo{(1)~Adicionamos o mapa de memória~($m$) à configuração e regras
    explícitas para atribuição.  A avaliação de expressões aritméticas e
    booleanas está encapsulada na função~$\eval$.\newline
    %%
    (2)~Adicionamos regras para consumir
    instruções~$\ceu{\protect\Skip}$.\newline
    %%
    (3)~Adicionamos condições que garantem que a cada passo apenas uma regra
    é aplicável---não há escolha.  Outra forma menos verbosa de fazer isso é
    dizer que elas devem ser avaliadas na ordem em que foram declaradas.
    Nesse caso, a primeira que for satisfeita deve ser aplicada.}

  \noindent\emph{Await and emit}
    \begin{alignat}{2}
      \label{def:orig:inner:await}
      \<\ceu{\Await(e)},\alpha,m>
      &\step{n}\<\ceu{\Awaiting(e,n')},\alpha,m>
      &&\quad\text{with~$n'=n+1$}
      \\[1\jot]
      %%
      \label{def:orig:inner:awaiting}
      \<\ceu{\Awaiting(e,n')},e\alpha,m>
      &\step{n}\<\ceu{\Skip},e\alpha,m>
      &&\quad\text{if~$n'\le{n}$}
      \\[1\jot]
      %%
      \label{def:orig:inner:emit}
      \<\ceu{\Emit(e)},\alpha,m>
      &\step{n}\<\ceu{\Emitting(n')},e\alpha,m>
      &&\quad\text{with~$n'=\|\alpha|$}
      \\[1\jot]
      %%
      \label{def:orig:inner:emitting}
      \<\ceu{\Emitting(n')},\alpha,m>
      &\step{n}\<\ceu{\Skip},\alpha,m>
      &&\quad\text{if~$n'=\|\alpha|$}
    \end{alignat}

    \noindent\emph{Conditionals}
    \begin{alignat}{2}
      \label{def:orig:inner:if-true}
      \<\ceu{\Ifelse{b}{p_1}{p_2}},\alpha,m>
      &\step{n}\<p_1,\alpha,m>
      &&\quad\text{if~$\eval(b,m)=1$}
      \\[1\jot]
      %%
      \label{def:orig:inner:if-false}
      \<\ceu{\Ifelse{b}{p_1}{p_2}},\alpha,m>
      &\step{n}\<p_2,\alpha,m>
      &&\quad\text{if~$\eval(b,m)=0$}
    \end{alignat}

    \noindent\emph{Sequences}
    \begin{alignat}{2}
      \label{def:orig:inner:seq-skip}
      \MARK{\<\ceu\Skip;p,\alpha,m>}
      &\MARK{\step{n}\<p,\alpha,m>}
      &&
      \\[1\jot]
      %%
      \label{def:orig:inner:seq-attr}
      \<\ceu{\Attr{v}{a}};p,\alpha,m>
      &\step{n}\<p,\alpha,m'>
      &&\quad\text{with~$m'=m[v/\eval(a)]$}
      \\[1\jot]
      %%
      \label{def:orig:inner:seq-break}
      \<\ceu{\Break;p},\alpha,m>
      &\step{n}\<\ceu{\Break},\alpha,m>
      &&
      \\[1\jot]
      %%
      \label{def:orig:inner:seq}
      &\hskip-5.35em
      \AXC{$\<p_1,\alpha,m>\step{n}\<p_1',\alpha',m'>$}
      \UIC{$\<p_1;p_2,\alpha,m>\step{n}\<p_1';p_2,\alpha',m'>$}
      \DP
      &&\quad\text{\MARK{if~$p_1\ne\ceu{\Skip},
          \ceu{\Attr{v}{a}},\ceu{\Break}$}}
    \end{alignat}

    \noindent\emph{Loops}
    \begin{alignat}{2}
      \label{def:orig:inner:loop}
      \<\ceu{\Loop p},\alpha,m>
      &\step{n}\<\ceu{p\Atloop{p}},\alpha,m>
      &&
      \\[1\jot]
      %%
      \label{def:orig:inner:atloop-skip}
      \MARK{\<\ceu{\Skip\Atloop{p}},\alpha,m>}
      &\MARK{\step{n}\<\ceu{\Loop{p}},\alpha,m>}
      &&
      \\[1\jot]
      %%
      \label{def:orig:inner:atloop-attr}
      \<\ceu{\Attr{v}{a}\Atloop{p}},\alpha,m>
      &\step{n}\<\ceu{\Loop{p}},\alpha,m'>
      &&\quad\text{with~$m'=m[v/\eval(a)]$}
      \\[1\jot]
      %%
      \label{def:orig:inner:atloop-break}
      \<\ceu{\Break\Atloop{p}},\alpha,m>
      &\step{n}\<\ceu{\Skip},\alpha,m>
      &&
      \\[1\jot]
      %%
      \label{def:orig:inner:atloop}
      &\hskip-7.75em
      \AXC{$\<p_1,\alpha,m>\step{n}\<p_1',\alpha',m'>$}
      \UIC{$\<\ceu{p_1\Atloop{p_2}},\alpha,m>
        \step{n}\<\ceu{p_1'\Atloop{p_2}},\alpha',m'>$}
      \DP
      &&\quad\parbox{8em}{\MARK{if~$p_1\ne\ceu{\Skip}$,\\
          \strut\enspace$\ceu{\Attr{v}{a}},\ceu{\Break}$}}
    \end{alignat}

    \noindent\emph{Par/and}
    %%
    \todo{Adicionamos a condição de o lado esquerdo estar bloqueado na
      regra~\ref{def:orig:inner:and-attr-right}.}
    %%
    \begin{alignat}{2}
      \label{def:orig:inner:and-skip-left}
      \<\ceu{\Skip\And{\;p}},\alpha,m>
      &\step{n}\<p,\alpha,m>
      &&
      \\[1\jot]
      %%
      \label{def:orig:inner:and-skip-right}
      \<\ceu{p\And\Skip},\alpha,m>
      &\step{n}\<p,\alpha,m>
      &&
      \\[1\jot]
      %%
      \label{def:orig:inner:and-attr-left}
      \<\ceu{\Attr{v}{a}\And{p}},\alpha,m>
      &\step{n}\<p,\alpha,m'>
      &&\quad\text{with~$m'=m[v/\eval(a)]$}
      \\[1\jot]
      %%
      \label{def:orig:inner:and-attr-right}
      \<\ceu{p\And\Attr{v}{a}},\alpha,m>
      &\step{n}\<p,\alpha,m'>
      &&\quad\parbox{10em}{\MARK{if~$\blocked(p,\alpha,n)=1$,}\\
        \strut\enspace with~$m'=m[v/\eval(a)]$}
      \\[1\jot]
      %%
      \label{def:orig:inner:and-break-left}
      \<\ceu{\Break\And\;p},\alpha,m>
      &\step{n}\<\ceu{p';\Break},\alpha,m>
      &&\quad\parbox{10em}{\MARK{if~$p\ne\ceu{\Skip,\Attr{v}{a}}$},\\
        \strut\enspace with~$p'=\clear(p)$}
      \\[1\jot]
      %%
      \label{def:orig:inner:and-break-right}
      \<\ceu{p\And\Break},\alpha,m>
      &\step{n}\<\ceu{p';\Break},\alpha,m>
      &&\quad\parbox{10em}{if~$\blocked(p,\alpha,n)=1$,\\
        \strut\enspace with~$p'=\clear(p)$}
      \\[1\jot]
      %%
      &\hskip-6.9em
      \label{def:orig:inner:and-left}
      \AXC{$\<p_1,\alpha,m>\step{n}\<p_1',\alpha',m'>$}
      \UIC{$\<\ceu{p_1\And{p_2}},\alpha,m>\step{n}
        \<\ceu{p_1'\And{p_2}},\alpha',m'>$}
      \DP
      &&\quad\parbox{10em}{if~$\blocked(p_1,\alpha,n)=0$\\
        \strut\enspace and~\MARK{$p_1\ne\ceu{\Skip}$,\\
        \strut\enspace $\ceu{\Attr{v}{a}},\ceu{\Break}$}}
      \\[1\jot]
      %%
      &\hskip-6.9em
      \label{def:orig:inner:and-right}
      \AXC{$\<p_2,\alpha,m>\step{n}\<p_2',\alpha',m'>$}
      \UIC{$\<\ceu{p_1\And{p_2}},\alpha,m>\step{n}
        \<\ceu{p_1\And{p_2'}},\alpha',m'>$}
      \DP
      &&\quad\parbox{10em}{if~$\blocked(p_1,\alpha,n)=1$\\
        \strut\enspace and~\MARK{$p_2\ne\ceu{\Skip}$,\\
        \strut\enspace $\ceu{\Attr{v}{a}},\ceu{\Break}$}}
    \end{alignat}

    \noindent\emph{Par/or}
    \begin{alignat}{2}
      \label{def:orig:inner:or-skip-left}
      \<\ceu{\Skip\Or{\;p}},\alpha,m>
      &\step{n}\<p',\alpha,m>
      &&\quad\parbox{11em}{\MARK{with~$p'=\clear(p)$}}
      \\[1\jot]
      %%
      \label{def:orig:inner:or-skip-right}
      \<\ceu{p\Or\Skip},\alpha,m>
      &\step{n}\<p',\alpha,m>
      &&\quad\parbox{10em}{\MARK{if~$\blocked(p,\alpha,n)=1$,\\
        \strut\enspace with~$p'=\clear(p)$}}
      \\[1\jot]
      %%
      \label{def:orig:inner:or-attr-left}
      \<\ceu{\Attr{v}{a}\Or{p}},\alpha,m>
      &\step{n}\<p',\alpha,m'>
      &&\quad\parbox{10em}{with~$m'=m[v/\eval(a)]$\\
        \strut\enspace and~$p'=\clear(p)$}
      \\[1\jot]
      %%
      \label{def:orig:inner:or-attr-right}
      \<\ceu{p\Or\Attr{v}{a}},\alpha,m>
      &\step{n}\<p',\alpha,m'>
      &&\quad\parbox{10em}{if~$\blocked(p,\alpha,n)=1$,\\
        \strut\enspace with~$m'=m[v/\eval(a)]$\\
        \strut\enspace and~$p'=\clear(p)$}
      \\[1\jot]
      %%
      \label{def:orig:inner:or-break-left}
      \<\ceu{\Break\Or\;p},\alpha,m>
      &\step{n}\<\ceu{p';\Break},\alpha,m>
      &&\quad\text{with~$p'=\clear(p)$}
      \\[1\jot]
      %%
      \label{def:orig:inner:or-break-right}
      \<\ceu{p\Or\Break},\alpha,m>
      &\step{n}\<\ceu{p';\Break},\alpha,m>
      &&\quad\parbox{10em}{if~$\blocked(p,\alpha,n)=1$,\\
        \strut\enspace with~$p'=\clear(p)$}
      \\[1\jot]
      %%
      &\hskip-6.4em
      \label{def:orig:inner:or-left}
      \AXC{$\<p_1,\alpha,m>\step{n}\<p_1',\alpha',m'>$}
      \UIC{$\<\ceu{p_1\Or{p_2}},\alpha,m>\step{n}
        \<\ceu{p_1'\Or{p_2}},\alpha',m'>$}
      \DP
      &&\quad\parbox{10em}{if~$\blocked(p_1,\alpha,n)=0$\\
        \strut\enspace and~\MARK{$p_1\ne\ceu{\Skip}$,\\
        \strut\enspace $\ceu{\Attr{v}{a}},\ceu{\Break}$}}\\[1\jot]
      %%
      &\hskip-6.4em
      \label{def:orig:inner:or-right}
      \AXC{$\<p_2,\alpha,m>\step{n}\<p_2',\alpha',m'>$}
      \UIC{$\<\ceu{p_1\Or{p_2}},\alpha,m>\step{n}
        \<\ceu{p_1\Or{p_2'}},\alpha',m'>$}
      \DP
      &&\quad\parbox{10em}{if~$\blocked(p_1,\alpha,n)=1$\\
        \strut\enspace and~\MARK{$p_2\ne\ceu{\Skip}$,\\
        \strut\enspace $\ceu{\Attr{v}{a}},\ceu{\Break}$}}
    \end{alignat}
\end{definition}

The next theorem establishes that the reaction inner-step relation is
deterministic, i.e., that it is in fact a \emph{partial} function.

\begin{theorem}[label={thm:orig:det-inner},
name={Determinism of the inner-step relation}]
For all~$p$, $p_1$, $p_2\in{P}$, $\alpha$, $\alpha_1$, $\alpha_2\in{E^*}$,
$m$, $m_1$, $m_2\in\mathcal{M}$, and~$n\in{N}$,
\begin{gather*}
  \text{if}\quad\<p,\alpha,m>\step{n}\<p_1,\alpha_1,m_1>
  \quad\text{and}\quad
  \<p,\alpha,m>\step{n}\<p_2,\alpha_2,m_2>,\\
  \text{then}\quad\<p_1,\alpha_1,m_1>=\<p_2,\alpha_2,m_2>.
\end{gather*}
\end{theorem}
\begin{proof}
  By induction on the structure of derivations.
  Suppose
  \[
    d_1\Vdash\<p,\alpha,m>\step{n}\<p_1,\alpha_1,m_1>
    \quad\text{and}\quad
    d_2\Vdash\<p,\alpha,m>\step{n}\<p_2,\alpha_2,m_2>,
  \]
  for some derivations~$d_1$ and~$d_2$.  Then there are ten possibilities
  depending on the structure of~$p$.  (Note that~$p$ cannot be equal
  to~$\ceu{\Skip}$, $\ceu{\Attr{v}{a}}$, or $\ceu{\Break}$, as there are no
  rules to evaluate such programs.)
  \begin{case}
  \item$p=\ceu{\Await(e)}$, for some~$e\in{E}$.  Then~$d_1$ and~$d_2$ are
    instances of axiom~\eqref{def:orig:inner:await}, and as such,
    $p_1=p_2=\ceu{\Awaiting(e,n')}$ with~$n'=n+1$, and
    $\alpha_1=\alpha_2=\alpha$ and~$m_1=m_2=m$.
    %%
  \item$p=\ceu{\Awaiting(e,n')}$, for some~$e\in{E}$ and~$n'\in{N}$.
    Then~$d_1$ and~$d_2$ are instances of
    axiom~\eqref{def:orig:inner:awaiting}, with~$n'\le{n}$.
    Thus~$p_1=p_2=\ceu{\Skip}$, $\alpha_1=\alpha_2=\alpha$, and~$m_1=m_2=m$.
    %%
  \item$p=\ceu{\Emit(e)}$, for some~$e\in{E}$.  Then~$d_1$ and~$d_2$ are
    instances of axiom~\eqref{def:orig:inner:emit}, and as such,
    $p_1=p2=\ceu{\Emitting(n')}$ with~$n'=\|\alpha|$,
    and~$\alpha_1=\alpha_2=e\alpha$ and~$m_1=m_2=m$.
    %%
  \item$p=\ceu{\Emitting(e,n')}$, for some~$e\in{E}$ and~$n'\in{N}$.
    Then~$d_1$ and~$d_2$ are instances of
    axiom~\eqref{def:orig:inner:emitting} with~$n'=\|\alpha|$.
    Thus~$p_1=p_2=\ceu{\Skip}$, $\alpha_1=\alpha_2=\alpha$ and~$m_1=m_2=m$.
    %%
  \item$p=\ceu{\Ifelse{b}{p'}{p''}}$, for some~$b\in{B}$ and~$p'$,
    $p''\in{P}$.
    \begin{case}
    \item$\eval(b,m)=1$.  Then~$d_1$ and~$d_2$ are instances of
      axiom~\eqref{def:orig:inner:if-true}, and as such, $p_1=p_2=p'$,
      $\alpha_1=\alpha_2=\alpha$, and~$m_1=m_2=m$.
    \item$\eval(b,m)=0$.  Then~$d_1$ and~$d_2$ are instances of
      axiom~\eqref{def:orig:inner:if-false}, and as such, $p_1=p_2=p''$,
      $\alpha_1=\alpha_2=\alpha$, and~$m_1=m_2=m$.
    \end{case}
  \item$p=\ceu{p';p''}$, for some~$p'$, $p''\in{P}$.
    \begin{case}
    \item$p'=\ceu\Skip$.  Then~$d_1$ and~$d_2$ are instances of
      axiom~\eqref{def:orig:inner:seq-skip}, and as such, $p_1=p_2=p''$,
      $\alpha_1=\alpha_2=\alpha$ and $m_1=m_2=m$.
    \item$p'=\ceu{\Attr{v}{a}}$, for some~$v\in{V}$ and~$a\in{A}$.
      Then~$d_1$ and~$d_2$ are instances of
      axiom~\eqref{def:orig:inner:seq-attr}, and as such, $p_1=p_2=p''$,
      $\alpha_1=\alpha_2=\alpha$ and, as~$\eval$ is a total function,
      $m_1=m_2=m[v/\eval(a)]$.
    \item$p'=\ceu{\Break}$.  Then~$d_1$ and~$d_2$ are instances of
      axiom~\eqref{def:orig:inner:seq-break}, and as such, $p_1=p_2=p'$,
      $\alpha_1=\alpha_2=\alpha$ and~$m_1=m_2=m$.
    \item$p'\ne\ceu{\Skip,\Attr{v}{a}},\ceu{\Break}$.  Then~$d_1$ and~$d_2$
      are instances of rule~\eqref{def:orig:inner:seq}.  Thus there are
      derivations~$d_1'$ and~$d_2'$ such that
      \begin{align*}
        d_1'\Vdash\<p',\alpha,m>\step{n}\<p_1',\alpha_1,m_1>
        \quad\text{and}\quad
        d_2'\Vdash\<p',\alpha,m>\step{n}\<p_2',\alpha_2,m_2>,
      \end{align*}
      for some~$p_1'$, $p_2'\in{P}$.  Since~$d_1'\prec{d_1}$
      and~$d_2'\prec{d_2}$, by induction hypothesis, $\alpha_1=\alpha_2$,
      $m_1=m_2$, and~$p_1'=p_2'$, which implies
      \[
        p_1=p_1';p''=p_2';p''=p_2.
      \]
    \end{case}
    %%
  \item$p=\ceu{\Loop{p'}}$, for some~$p'\in{P}$.  Then~$d_1$ and~$d_2$ are
    instances of axiom~\eqref{def:orig:inner:loop}, and as such,
    $p_1=p_2=\ceu{p'\Atloop{p'}}$, $\alpha_1=\alpha_2=\alpha$,
    and~$m_1=m_2=m$.
    %%
  \item$p=\ceu{p'\Atloop{p''}}$, for some~$p'$, $p''\in{P}$.
    \begin{case}
    \item$p=\ceu{\Skip\Atloop{p'}}$, for some~$p'\in{P}$.  Then~$d_1$
      and~$d_2$ are instances of axiom~\eqref{def:orig:inner:atloop-skip},
      and as such, $p_1=p_2=\ceu{\Loop{p'}}$, $\alpha_1=\alpha_2=\alpha$,
      and~$m_1=m_2=m$.
    \item$p=\ceu{\Attr{v}{a}\Atloop{p'}}$, for some~$a\in{A}$, $v\in{V}$,
      and~$p'\in{P}$.  Then~$d_1$ and~$d_2$ are instances
      of axiom~\eqref{def:orig:inner:atloop-attr}, and as such,
      $p_1=p_2=\ceu{\Loop{p'}}$, $\alpha_1=\alpha_2=\alpha$, and as~$\eval$
      is a total function, $m_1=m_2=m[v/\eval(a)]$.
    \item$p=\ceu{\Break\Atloop{p'}}$, for some~$p'\in{P}$.  Then~$d_1$
      and~$d_2$ are instances of axiom~\eqref{def:orig:inner:atloop-break},
      and as such, $p_1=p_2=\ceu{\Skip}$, $\alpha_1=\alpha_2=\alpha$,
      and~$m_1=m_2=m$.
    \item$p=\ceu{p'\Atloop{p''}}$, for some~$p'$, $p''\in{P}$ such
      that~$p'\ne\ceu{\Skip,\Attr{v}{a}},\ceu{\Break}$.  Then~$d_1$
      and~$d_2$ are instances of rule~\eqref{def:orig:inner:atloop}.  Thus
      there are derivations~$d_1'$ and~$d_2'$ such that
      \[
        d_1'\Vdash\<p',\alpha,m>\step{n}\<p_1',\alpha_1,m_1>
        \quad\text{and}\quad
        d_2'\Vdash\<p',\alpha,m>\step{n}\<p_2',\alpha_2,m_2>,
      \]
      for some~$p_1'$, $p_2'\in{P}$.  Since~$d_1'\prec{d_1}$
      and~$d_2'\prec{d_2}$, by induction hypothesis, $\alpha_1=\alpha$,
      $m_1=m_2$, and~$p_1'=p_2'$, which implies
      \[
        p_1=\ceu{p_1'\Atloop{p''}}=\ceu{p_2'\Atloop{p''}}=p_2.
      \]
    \end{case}
    %%
  \item\label{thm:orig:det-inner:and} $p=\ceu{p'\And{p''}}$, for some~$p'$,
    $p''\in{P}$.
    \begin{case}
    \item\label{thm:orig:det-inner:and-skip-left}
      $p=\ceu{\Skip\And{\;p'}}$, for some~$p'\in{P}$.
      Then~$d_1$ and~$d_2$ are instances of
      axiom~\eqref{def:orig:inner:and-skip-left}, and as such, $p_1=p_2=p'$,
      $\alpha_1=\alpha_2=\alpha$, and $m_1=m_2=m$.
    \item$p=\ceu{p'\And\Skip}$, for some~~$p'\in{P}$.
      Similar to \Cref{thm:orig:det-inner:and-skip-left}.
    \item\label{thm:orig:det-inner:and-attr-left}
      $p=\ceu{\Attr{v}{a}\And{p'}}$, for some~$v\in{V}$, $a\in{A}$
      and~$p'\in{P}$.  Then~$d_1$ and~$d_2$ are instances of
      axiom~\eqref{def:orig:inner:and-attr-left}, and as such, $p_1=p_2=p'$,
      $\alpha_1=\alpha_2=\alpha$, and as~$\eval$ is a total function,
      $m_1=m_2=m[v/\eval(a)]$.
    \item$p=\ceu{p'\And\Attr{v}{a}}$, for some~$v\in{V}$, $a\in{A}$
      and~$p'\in{P}$.  Then either~$\blocked(p')=0$ or~$\blocked(p')=1$.
      If~$\blocked(p')=0$ then this case becomes
      \Cref{thm:orig:det-inner:and-left}.  Otherwise, if~$\blocked(p')=1$,
      then~$d_1$ and~$d_2$ are instances of
      axiom~\eqref{def:orig:inner:and-attr-right}, and as such,
      $p_1=p_2=p'$, $\alpha_1=\alpha_2=\alpha$, and as~$\eval$ is a total
      function, $m_1=m_2=m[v/\eval(a)]$.
    \item$p=\ceu{\Break\And{\;p'}}$, for some~$p'\in{P}$.  Then~$d_1$
      and~$d_2$ are instances of
      axiom~\eqref{def:orig:inner:and-break-left}, and as such,
      $\alpha_1=\alpha_2=\alpha$, $m_1=m_2=m$, and as~$\clear$ is a total
      function, $p_1=p_2=\ceu{\clear(p');\Break}$.
    \item$p=\ceu{{p'}\And\Break}$, for some~$p'\in{P}$.  Then
      either~$\blocked(p')=0$ or~$\blocked(p')=1$.  If~$\blocked(p')=0$ then
      this case becomes \Cref{thm:orig:det-inner:and-left}.  Otherwise,
      if~$\blocked(p')=1$, then~$d_1$ and~$d_2$ are instances of
      axiom~\eqref{def:orig:inner:and-break-right}, and as such,
      $\alpha_1=\alpha_2=\alpha$, $m_1=m_2=m$, and as~$\clear$ is a total
      function, $p_1=p_2=\ceu{\clear(p');\Break}$.
    \item\label{thm:orig:det-inner:and-left} $p=\ceu{p'\And{p''}}$, for
      some~$p'$ and~$p''\in{P}$.  Then there are two possibilities.
      If~$\blocked(p')=0$ then~$d_1$ and~$d_2$ are instances
      of~\eqref{def:orig:inner:and-left}.  Thus there are derivations~$d_1'$
      and~$d_2'$ such that
      \[
        d_1'\Vdash\<p',\alpha,m>\step{n}\<p_1',\alpha_1,m_1>
        \quad\text{and}\quad
        d_2'\Vdash\<p',\alpha,m>\step{n}\<p_2',\alpha_2,m_2>,
      \]
      for some~$p_1'$, $p_2'\in{P}$.  Since~$d_1'\prec{d_1}$
      and~$d_2'\prec{d_2}$, by induction hypothesis, $\alpha_1=\alpha_2$,
      $m_1=m_2$, and~$p_1'=p_2'$, which implies
      \[
        p_1=(\ceu{p_1'\And{p''}})=(\ceu{p_2'\And{p''}})=p_2.
      \]

      If, however, $\blocked(p')=1$ and
      $p''\ne\ceu{\Skip,\Attr{v}{a},\Break}$, then~$d_1$ and~$d_2$ are
      instances of~~\eqref{def:orig:inner:and-right}.  Thus there are
      derivations~$d_1''$ and~$d_2''$ such that
      \[
        d_1''\Vdash\<p'',\alpha,m>\step{n}\<p_1'',\alpha_1,m_1>
        \quad\text{and}\quad
        d_2''\Vdash\<p'',\alpha,m>\step{n}\<p_2'',\alpha_2,m_2>,
      \]
      for some~$p_1''$, $p_2''\in{P}$.  Since~$d_1''\prec{d_1}$
      and~$d_2''\prec{d_2}$, by induction hypothesis, $\alpha_1=\alpha_2$,
      $m_1=m_2$, and~$p_1''=p_2''$, which implies
      \[
        p_1=(\ceu{p'\And{p_1''}})=(\ceu{p'\And{p_2''}})=p_2.
      \]
    \end{case}
    %%
  \item$p=\ceu{p'\Or{p''}}$, for some~$p'$, $p''\in{P}$.
    \begin{case}
    \item$p=\ceu{\Skip\Or{\;p'}}$, for some~$p'\in{P}$.  Then~$d_1$
      and~$d_2$ are instances of axiom~\eqref{def:orig:inner:or-skip-left},
      and as such, $\alpha_1=\alpha_2=\alpha$, $m_1=m_2=m$, and as~$\clear$
      is a total, $p_1=p_2=\ceu\clear(p')$.
    \item$p=\ceu{p'\Or\Skip}$, for some~$p'\in{P}$.  Then
      either~$\blocked(p')=0$ or~$\blocked(p')=1$.  If~$\blocked(p')=0$ then
      this case becomes \Cref{thm:orig:det-inner:or-left}.  Otherwise,
      if~$\blocked(p')=1$, then~$d_1$ and~$d_2$ are instances of
      axiom~\eqref{def:orig:inner:or-skip-right}, and as such,
      $\alpha_1=\alpha_2=\alpha$, $m_1=m_2=m$, and as~$\clear$ is a total
      function, $p_1=p_2=\ceu\clear(p')$.
    \item\label{thm:orig:det-inner:or-attr-left}
      $p=\ceu{\Attr{v}{a}\Or{p'}}$, for some~$v\in{V}$, $a\in{A}$
      and~$p'\in{P}$.  Then~$d_1$ and~$d_2$ are instances of
      axiom~\eqref{def:orig:inner:or-attr-left}, and as such,
      $\alpha_1=\alpha_2=\alpha$, and as~$\eval$ and~$\clear$ are total
      functions, $m_1=m_2=m[v/\eval(a)]$ and~$p_1=p_2=\ceu\clear(p')$.
    \item$p=\ceu{p'\Or\Attr{v}{a}}$, for some~$v\in{V}$, $a\in{A}$
      and~$p'\in{P}$.  Then either~$\blocked(p')=0$ or~$\blocked(p')=1$.
      If~$\blocked(p')=0$ then this case becomes
      \Cref{thm:orig:det-inner:or-left}.  Otherwise, if~$\blocked(p')=1$,
      then~$d_1$ and~$d_2$ are instances of
      axiom~\eqref{def:orig:inner:or-attr-right}, and as such,
      $\alpha_1=\alpha_2=\alpha$, and as~$\eval$ and~$\clear$ are total
      functions, $m_1=m_2=m[v/\eval(a)]$ and~$p_1=p_2=\ceu\clear(p')$.
    \item$p=\ceu{\Break\Or{\;p'}}$, for some~$p'\in{P}$.  Then~$d_1$
      and~$d_2$ are instances of axiom~\eqref{def:orig:inner:or-break-left},
      and as such, $\alpha_1=\alpha_2=\alpha$, $m_1=m_2=m$, and as~$\clear$
      is a total function, $p_1=p_2=\ceu{\clear(p');\Break}$.
    \item$p=\ceu{{p'}\Or\Break}$, for some~$p'\in{P}$.  Then
      either~$\blocked(p')=0$ or~$\blocked(p')=1$.  If~$\blocked(p')=0$ then
      this case becomes \Cref{thm:orig:det-inner:or-left}.  Otherwise,
      if~$\blocked(p')=1$, then~$d_1$ and~$d_2$ are instances of
      axiom~\eqref{def:orig:inner:or-break-right}, and as such,
      $\alpha_1=\alpha_2=\alpha$, $m_1=m_2=m$, and as~$\clear$ is a total
      function, $p_1=p_2=\ceu{\clear(p');\Break}$.
    \item\label{thm:orig:det-inner:or-left}$p=\ceu{p'\Or{p''}}$, for
      some~$p'$ and~$p''\in{P}$.  Then there are two possibilities.
      If~$\blocked(p')=0$ then~$d_1$ and~$d_2$ are instances
      of~\eqref{def:orig:inner:or-left}.  Thus there are derivations~$d_1'$
      and~$d_2'$ such that
      \[
        d_1'\Vdash\<p',\alpha,m>\step{n}\<p_1',\alpha_1,m_1>
        \quad\text{and}\quad
        d_2'\Vdash\<p',\alpha,m>\step{n}\<p_2',\alpha_2,m_2>,
      \]
      for some~$p_1'$, $p_2'\in{P}$.  Since~$d_1'\prec{d_1}$
      and~$d_2'\prec{d_2}$, by induction hypothesis, $\alpha_1=\alpha_2$,
      $m_1=m_2$, and~$p_1'=p_2'$, which implies
      \[
        p_1=(\ceu{p_1'\Or{p''}})=(\ceu{p_2'\Or{p''}})=p_2.
      \]
      If, however, $\blocked(p')=1$ and
      $p''\ne\ceu{\Skip,\Attr{v}{a},\Break}$, then~$d_1$ and~$d_2$ are
      instances of~~\eqref{def:orig:inner:or-right}.  Thus there are
      derivations~$d_1''$ and~$d_2''$ such that
      \[
        d_1''\Vdash\<p'',\alpha,m>\step{n}\<p_1'',\alpha_1,m_1>
        \quad\text{and}\quad
        d_2''\Vdash\<p'',\alpha,m>\step{n}\<p_2'',\alpha_2,m_2>,
      \]
      for some~$p_1''$, $p_2''\in{P}$.  Since~$d_1''\prec{d_1}$
      and~$d_2''\prec{d_2}$, by induction hypothesis, $\alpha_1=\alpha_2$,
      $m_1=m_2$, and~$p_1''=p_2''$, which implies
      \[
        p_1=(\ceu{p'\Or{p_1''}})=(\ceu{p'\Or{p_2''}})=p_2.\qedhere
      \]
    \end{case}
  \end{case}
\end{proof}

The next lemma establishes that given a program either it is possible to
advance it by an inner-step or all its trails are blocked, but not both.

\begin{lemma}[label={lem:orig:inner-step-or-blocked}]
  For all~$p\in{P}$, $\alpha\in{E^*}$, $m\in\mathcal{M}$, and~$n\in{N}$,
  if~$p\ne\ceu{\Skip},\ceu{\Attr{v}{a}},\ceu{\Break}$ then either
  \[
    \exists{\delta\in\Delta}(\<p,\alpha,m>\step{n}\delta)
    \quad\text{or}\quad \blocked(p,\alpha,n)=1,
  \]
  but not both.
\end{lemma}
\begin{proof}
  By induction on the structure of programs.
  \begin{case}
  \item $p=\ceu{\Await(e)}$, for some~$e\in{E}$.  Then by
    axiom~\eqref{def:orig:inner:await},
    \[
      \<\ceu{\Await(e)},\alpha,m>
        \step{n}\<\ceu{\Awaiting(e,n')},\alpha,m>=\delta,
    \]
    where $n'=n+1$.  And by \Cref{def:orig:blocked},
    $\blocked(\ceu{\Await(e)},\alpha,n)=0$.
    %%
  \item $p=\ceu{\Awaiting(e,n')}$, for some~$e\in{E}$ and~$n'\in{N}$.
    \begin{case}
    \item$n'<n$.  If~$e$ is the top-of-stack event in~$\alpha$, in
      symbols~$e=\alpha_{[1]}$, then by
      axiom~\eqref{def:orig:inner:awaiting},
      \[
        \<\ceu{\Awaiting(e,n')},\alpha,m>
        \step{n}\<\ceu{\Skip},\alpha,m>=\delta.
      \]
      And by \Cref{def:orig:blocked},
      $\blocked(\ceu{\Awaiting(e,n')},\alpha,n)=0$.

      \par If, however, $e\ne\alpha_{[1]}$, then there is no such~$\delta$,
      as no rule is applicable.  And by \Cref{def:orig:blocked},
      $\blocked(\ceu{\Awaiting(e,n')},\alpha,n)=1.$
    \item$n'=n$.
      \FIXME{
        Pelo axioma~\eqref{def:orig:inner:awaiting},
        \[
          \<\ceu{\Awaiting(e,n')},\alpha,m>
          \step{n}\<\ceu{\Skip},\alpha,m>.
        \]
        E~$\blocked(\ceu{\Awaiting(e,n')},\alpha,n)=1$.
        Ou seja, ambos os lados do ``ou'' deram verdadeiro, o que invalida o
        lema.
      }
    \item$n'>n$.  If~$e=\alpha_{[1]}$ then
      \FIXME{
        Não existe tal~$\delta$ e
        \[
          \blocked(\ceu{\Awaiting(e,n')},\alpha,n)=0.
        \]
        O que, novamente, invalida o lema.
      }
      \par If, however, $e\ne\alpha_{[1]}$, then there is no such~$\delta$
      (no rule is applicable) and, by~\Cref{def:orig:blocked},
      $\blocked(\ceu{\Awaiting(e,n')},\alpha,n)=1$.
    \end{case}
    %%
  \item$p=\ceu{\Emit(e)}$, for some~$e\in{E}$.  Then by
    axiom~\eqref{def:orig:inner:emit},
    \[
      \<\ceu{\Emit(e)},\alpha,m>
      \step{n}\<\ceu{\Emitting(n')},e\alpha,m>=\delta,
    \]
    where~$n'=\|\alpha|$.  And by~\Cref{def:orig:blocked},
    $\blocked(\ceu{\Emit(e')},e\alpha,n)=0$.
    %%
  \item $p=\ceu{\Emitting(e,n')}$, for some~$e\in{E}$ and~$n'\in{N}$.
    \begin{case}
    \item~$n'=\|\alpha|$.  By axiom~\eqref{def:orig:inner:emitting},
      \[
        \<\ceu{\Emitting(e,n')},\alpha,m>
        \step{n}\<\ceu{\Skip},\alpha,m>=\delta.
      \]
      And by \Cref{def:orig:blocked},
      $\blocked(\ceu{\Emitting(e,n')},\alpha,n)=0$.
    \item~$n'\ne\|\alpha|$.  Then there is no such~$\delta$ (no rule is
      applicable) and, by \Cref{def:orig:blocked},
      $\blocked(\ceu{\Emitting(e,n')},\alpha,n)=1$.
    \end{case}
    %%
  \item $p=\ceu{\Ifelse{b}{p'}{p''}}$, for some~$b\in{B}$ and~$p'$,
    $p''\in{P}$.  By axioms~\eqref{def:orig:inner:if-true}
    and~\eqref{def:orig:inner:if-false}, if~$\eval(b,m)=1$,
    $\delta=\<p',\alpha,m>$, otherwise~$\delta=\<p'',\alpha,m>$.  And
    by~\Cref{def:orig:blocked},
    $\blocked(\ceu{\Ifelse{b}{p'}{p''}},e\alpha,n)=0$
  \item$p=\ceu{p';p''}$, for some~$p'$, $p''\in{P}$.
    \begin{case}
    \item$p'=\ceu{\Skip}$.  By axiom~\eqref{def:orig:inner:seq-skip},
      $\delta=\<p'',\alpha,m>$, and by~\Cref{def:orig:blocked},
      $\blocked(\ceu{\Skip},\alpha,n)=0$.
    \item$p'=\ceu{\Attr{v}{a}}$, for some~$v\in{V}$ and~$a\in{A}$.  By
      axiom~\eqref{def:orig:inner:seq-attr},
      $\delta=\<p'',\alpha,m[v/\eval(a)]>$, and by~\Cref{def:orig:blocked},
      $\blocked(\ceu{\Attr{v}{a}},\alpha,n)=0$.
    \item$p'=\ceu{\Break}$.  By axiom~\eqref{def:orig:inner:seq-break},
      $\delta=\<\ceu{Break},\alpha,m>$, and by~\Cref{def:orig:blocked},
      $\blocked(\ceu{\Break},\alpha,n)=0$.

      \item$p'\ne\ceu{\Skip},\ceu{\Attr{v}{a}},\ceu{\Break}$.  By induction
        hypothesis, exactly one of the following hold:
        \[
          \exists{d'\in\Delta}(\<p',\alpha,m>\step{n}d')
          \quad\text{or}\quad
          \blocked(p',\alpha,n)=1.
        \]

        Suppose~$\<p',\alpha,m>\step{n}\<p_1',\alpha',m'>$, for
        some~$p_1'\in{P}$, $\alpha'\in{E^*}$, and~$m'\in\mathcal{M}$.  Then
        by rule~\eqref{def:orig:inner:seq},
        \[
          \<p';p'',\alpha,m>\step{n}\<p'_1;p'',\alpha',m'>.
        \]
        And by \Cref{def:orig:blocked},
        \[
          \blocked(p';p'',\alpha,n)=\blocked(p',\alpha,n)=0.
        \]

        If, however,~$\blocked(p',\alpha,n)=1$, then there is no such~$d$
        (no rule is applicable) and by \Cref{def:orig:blocked},
        \[
          \blocked(p';p'',\alpha,n)=\blocked(p',\alpha,n)=1.
        \]
      \end{case}
    %%
  \item
  \MARK{ 
    $p=\ceu{\Loop{p'}}$, for some~$p'\in{P}$.  Then we can derive~$\delta$
    using the axiom~\eqref{def:orig:inner:loop}, and as such,
    $\delta=\<\ceu{p'\Atloop{p'}},e\alpha,m>$, and according to 
    definition~\ref{def:orig:blocked}, $\blocked(\ceu{\Loop{p'}},e\alpha,n)=0$.
  }
    %%
  \item
  \MARK{
    $p=\ceu{p'\Atloop{p''}}$, for some~$p'$, $p''\in{P}$.
    According to definition~\ref{def:orig:blocked},
    $\blocked(\ceu{p'\Atloop{p''}},e\alpha,n)=\blocked(\ceu{p'},e\alpha,n)$.
    \begin{case}
    \item$p=\ceu{\Skip\Atloop{p'}}$, for some~$p'\in{P}$.  
      Then we can derive~$\delta$ using the
      axiom ~\eqref{def:orig:inner:atloop-skip}, and as such,
      $\delta=\<\ceu{\Loop{p'}},e\alpha,m>$, and 
      according to definition~\ref{def:orig:blocked},
      $\blocked(\ceu\Skip,e\alpha,n)=0$.
    \item$p=\ceu{\Attr{v}{a}\Atloop{p'}}$, for some~$p'\in{P}$.  
      Then we can derive~$\delta$ using the
      axiom ~\eqref{def:orig:inner:atloop-attr}, and as such,
      $\delta=\<\ceu{\Loop{p'}},e\alpha,m'>$, with $m'=m[v/\eval(a)]$, and 
      according to definition~\ref{def:orig:blocked},
      $\blocked(\ceu{\Attr{v}{a}},e\alpha,n)=0$.
    \item$p=\ceu{\Break\Atloop{p'}}$, for some~$p'\in{P}$.  
      Then we can derive~$\delta$ using the
      axiom ~\eqref{def:orig:inner:atloop-break}, and as such,
      $\delta=\<\ceu\Skip,e\alpha,m>$, and according to 
      definition~\ref{def:orig:blocked},
      $\blocked(\ceu\Break,e\alpha,n)=0$.
    \item$p=\ceu{p'\Atloop{p''}}$, for some~$p'$, $p''\in{P}$ such
      that~$p'\ne\ceu{\Skip,\Attr{v}{a}},\ceu{\Break}$.  
      \TODO{induction hypothesis}
    \end{case}
  }
    %%
  \item\label{thm:orig:lemma:and} 
  \MARK{
    $p=\ceu{p'\And{p''}}$, for some~$p'$,
    $p''\in{P}$. According to definition~\ref{def:orig:blocked},
    $\blocked(\ceu{p'\And{p''}},e\alpha,n)=\blocked(\ceu{p'},e\alpha,n)\cdot\blocked(\ceu{p''},e\alpha,n)$.
    \begin{case}
    \item\label{thm:orig:lemma:and-skip-left}
      $p=\ceu{\Skip\And{\;p'}}$, for some~$p'\in{P}$.  
      Then we can derive~$\delta$ using the
      axiom~\eqref{def:orig:inner:and-skip-left}, and as such,
      $\delta=\<\ceu{p'},e\alpha,m>$, and according to
      definition~\ref{def:orig:blocked},
      $\blocked(\ceu\Skip,e\alpha,n)=0$, therefore
      $\blocked(\ceu{\Skip\And{\;p''}},e\alpha,n)=0$.
    \item$p=\ceu{p'\And\Skip}$, for some~~$p'\in{P}$.  
      Similar to \Cref{thm:orig:det-inner:and-skip-left}.
    \item\label{thm:orig:lemma:and-attr-left}
      $p=\ceu{\Attr{v}{a}\And{p'}}$, for some~$v\in{V}$, $a\in{A}$
      and~$p'\in{P}$.  Then we can derive~$\delta$ using the 
      axiom~\eqref{def:orig:inner:and-attr-left}, and as such, 
      $\delta=<\ceu{p'},e\alpha,m'>$, with $m'=m[v/eval(a)]$, and according to
      definition~\ref{def:orig:blocked},
      $\blocked(\ceu{\Attr{v}{a}},e\alpha,n)=0$, therefore
      $\blocked(\ceu{\Attr{v}{a}\And{\;p''}},e\alpha,n)=0$.
    \item$p=\ceu{p'\And\Attr{v}{a}}$, for some~$v\in{V}$, $a\in{A}$
      and~$p'\in{P}$. Then there are two possibilities.
    \begin{itemize}
        \item if $\blocked(\ceu{p'},e\alpha,n)=1$, then according to
          definition~\ref{def:orig:blocked},
          $\blocked(\ceu{\Attr{v}{a}},e\alpha,n)=0$, thus
        $\blocked(\ceu{{p'}\And\Attr{v}{a}},e\alpha,n)=0$.
        In this case, we can derive $\delta$ using the
        axiom~\eqref{def:orig:inner:and-attr-right}, and as such,
        $\delta=\<\ceu{p'},e\alpha,m'>$, with $m'=m[v/eval(a)]$.
        %%
        \item if $\blocked(\ceu{p'},e\alpha,n)=0$ and
          $p'\ne \ceu{\Skip,\Attr{v}{a},\Break}$, then 
        $\blocked(\ceu{{p'}\And\Attr{v}{a}},e\alpha,n)=0$. The derivation
        of~$\delta$ becomes \Cref{thm:orig:lemma:and-left}
    \end{itemize}
    \item$p=\ceu{\Break\And{\;p'}}$, for some~$p'\in{P}$.  Then we can
      derive $\delta$ using the axiom~\eqref{def:orig:inner:and-break-left}, 
      and as such, $\delta=\<\clear(p'),e\alpha,m>$, and according to
      definition~\ref{def:orig:blocked}, $\blocked(\ceu{\Break},e\alpha,m)=0$,
      therefore $\blocked(\ceu{\Break\And{\;p'}},e\alpha,n)=0$
    \item$p=\ceu{{p'}\And\Break}$, for some~$p'\in{P}$.  Then there are 
      two possibilities.
    \begin{itemize}
        \item if $\blocked(\ceu{p'},e\alpha,n)=1$, then according to
          definition~\ref{def:orig:blocked},
          $\blocked(\ceu\Break,e\alpha,n)=0$, thus
        $\blocked(\ceu{p'\And\Break},e\alpha,n)=0$.
        In this case, we can derive $\delta$ using the
        axiom~\eqref{def:orig:inner:and-break-right}, and as such,
        $\delta=\<\ceu{\clear(p');\Break},e\alpha,m>$.
        %%
        \item if $\blocked(\ceu{p'},e\alpha,n)=0$ and
          $p'\ne \ceu{\Skip,\Attr{v}{a},\Break}$, then 
        $\blocked(\ceu{{p'}\And\Break},e\alpha,n)=0$. The derivation
        of~$\delta$ becomes \Cref{thm:orig:lemma:and-left}
    \end{itemize}
    \item\label{thm:orig:lemma:and-left} $p=\ceu{p'\And{p''}}$, for
      some~$p'$ and~$p''\in{P}$.  
      Then there are two possibilities.
      \begin{itemize}
        \item if $\blocked(p')=0$ and $p'\ne \ceu{\Skip,\Attr{v}{a},\Break}$, 
          then~$\blocked(\ceu{{p'}\And{p''}},e\alpha,m)=0$.
          We can derive~$\delta$ using the rule~\eqref{def:orig:inner:and-left},
          as such, $\delta=\<\ceu{p_1'\And{p''},e\alpha,m'}>$.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%PAREI AQUI%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
        % \item if $\blocked(p')=1$ and $p''\ne \ceu{\Skip,\Attr{v}{a},\Break}$, 
        %   then~$\blocked(\ceu{{p'}\And{p''}},e\alpha,m)=0$.
        %   We can derive~$\delta$ using the rule~\eqref{def:orig:inner:and-left},
        %   as such, $\delta=\<\ceu{p_1'\And{p''},e\alpha,m'}>$.
      \end{itemize}
      % If, however, $\blocked(p')=1$ \MARK{and $p''\ne\ceu{\Skip,\Attr{v}{a},\Break}$,}
      % then~$d_1$ and~$d_2$ are instances of~~\eqref{def:orig:inner:and-right}. 
      % Thus there are derivations~$d_1''$ and~$d_2''$ such that
      % \[
      %   d_1''\Vdash\<p'',\alpha,m>\step{n}\<p_1'',\alpha_1,m_1>
      %   \quad\text{and}\quad
      %   d_2''\Vdash\<p'',\alpha,m>\step{n}\<p_2'',\alpha_2,m_2>,
      % \]
      % for some~$p_1''$, $p_2''\in{P}$.  Since~$d_1''\prec{d_1}$
      % and~$d_2''\prec{d_2}$, by induction hypothesis, $\alpha_1=\alpha_2$,
      % $m_1=m_2$, and~$p_1''=p_2''$, which implies
      % \[
      %   p_1=(\ceu{p'\And{p_1''}})=(\ceu{p'\And{p_2''}})=p_2.
      % \]
    \end{case}
  }
    %%
  % \item$p=\ceu{p'\Or{p''}}$, for some~$p'$, $p''\in{P}$.  
  %   %\TODO{Similar to \Cref{thm:orig:det-inner:and} (we hope).}
  %   \begin{case}
  %   \item
  %   \MARK{
  %     $p=\ceu{\Skip\Or{\;p'}}$, for some~$p'\in{P}$.  
  %     Then~$d_1$ and~$d_2$ are instances of
  %     axiom~\eqref{def:orig:inner:or-skip-left}, and as such, 
  %     $\alpha_1=\alpha_2=\alpha$, $m_1=m_2=m$, and as~$\clear$ is a total, 
  %     $p_1=p_2=\ceu\clear(p')$. 
  %   }
  %   \item
  %   \MARK{
  %     $p=\ceu{p'\Or\Skip}$, for some~$p'\in{P}$.  
  %     Then either~$\blocked(p')=0$ or~$\blocked(p')=1$.  If~$\blocked(p')=0$ 
  %     then this case becomes \Cref{thm:orig:det-inner:or-left}.  Otherwise,
  %     if~$\blocked(p')=1$, then~$d_1$ and~$d_2$ are instances of
  %     axiom~\eqref{def:orig:inner:or-skip-right}, and as such,
  %     $\alpha_1=\alpha_2=\alpha$, $m_1=m_2=m$, and as~$\clear$ is a total
  %     function, $p_1=p_2=\ceu\clear(p')$.
  %   }
  %   \item\label{thm:orig:lemma:or-attr-left}
  %   \MARK{
  %     $p=\ceu{\Attr{v}{a}\Or{p'}}$, for some~$v\in{V}$, $a\in{A}$
  %     and~$p'\in{P}$.  Then~$d_1$ and~$d_2$ are instances of
  %     axiom~\eqref{def:orig:inner:or-attr-left}, and as such, 
  %     $\alpha_1=\alpha_2=\alpha$, as~$\eval$ is a total function, 
  %     $m_1=m_2=m[v/\eval(a)]$, and as~$\clear$ is a total
  %     function, $p_1=p_2=\ceu\clear(p')$.
  %   }
  %   \item
  %   \MARK{
  %     $p=\ceu{p'\Or\Attr{v}{a}}$, for some~$v\in{V}$, $a\in{A}$
  %     and~$p'\in{P}$. 
  %     Then either~$\blocked(p')=0$ or~$\blocked(p')=1$.  If~$\blocked(p')=0$ 
  %     then this case becomes \Cref{thm:orig:det-inner:or-left}.  Otherwise,
  %     if~$\blocked(p')=1$, then~$d_1$ and~$d_2$ are instances of
  %     axiom~\eqref{def:orig:inner:or-attr-right}, and as such,
  %     $\alpha_1=\alpha_2=\alpha$, as~$\eval$ is a total function, 
  %     $m_1=m_2=m[v/\eval(a)]$, and as~$\clear$ is a total
  %     function, $p_1=p_2=\ceu\clear(p')$.
  %   }
  %   \item
  %   \MARK{
  %     $p=\ceu{\Break\Or{\;p'}}$, for some~$p'\in{P}$.  Then~$d_1$
  %     and~$d_2$ are instances of
  %     axiom~\eqref{def:orig:inner:or-break-left}, and as such,
  %     $\alpha_1=\alpha_2=\alpha$, $m_1=m_2=m$, and as~$\clear$ is a total
  %     function, $p_1=p_2=\ceu{\clear(p');\Break}$.
  %   }
  %   \item
  %   \MARK{
  %     $p=\ceu{{p'}\Or\Break}$, for some~$p'\in{P}$.  Then
  %     either~$\blocked(p')=0$ or~$\blocked(p')=1$.  If~$\blocked(p')=0$ then
  %     this case becomes \Cref{thm:orig:det-inner:or-left}.  Otherwise,
  %     if~$\blocked(p')=1$, then~$d_1$ and~$d_2$ are instances of
  %     axiom~\eqref{def:orig:inner:or-break-right}, and as such,
  %     $\alpha_1=\alpha_2=\alpha$, $m_1=m_2=m$, and as~$\clear$ is a total
  %     function, $p_1=p_2=\ceu{\clear(p');\Break}$.
  %   }
  %   \item\label{thm:orig:lema:or-left} 
  %   \MARK{
  %     $p=\ceu{p'\Or{p''}}$, for
  %     some~$p'$ and~$p''\in{P}$.  
  %     Then there are two possibilities.
  %     If~$\blocked(p')=0$ then~$d_1$ and~$d_2$ are instances
  %     of~\eqref{def:orig:inner:or-left}.  Thus there are derivations~$d_1'$
  %     and~$d_2'$ such that
  %   }
  %     \[
  %   \MARK{
  %       d_1'\Vdash\<p',\alpha,m>\step{n}\<p_1',\alpha_1,m_1>
  %       \quad\text{and}\quad
  %       d_2'\Vdash\<p',\alpha,m>\step{n}\<p_2',\alpha_2,m_2>,
  %     }
  %     \]
  %   \MARK{
  %     for some~$p_1'$, $p_2'\in{P}$.  Since~$d_1'\prec{d_1}$
  %     and~$d_2'\prec{d_2}$, by induction hypothesis, $\alpha_1=\alpha_2$,
  %     $m_1=m_2$, and~$p_1'=p_2'$, which implies
  %   }
  %     \[
  %   \MARK{
  %       p_1=(\ceu{p_1'\Or{p''}})=(\ceu{p_2'\Or{p''}})=p_2.
  %     }
  %     \]

  %   \MARK{
  %     If, however, $\blocked(p')=1$ and $p''\ne\ceu{\Skip,\Attr{v}{a},\Break}$,
  %     then~$d_1$ and~$d_2$ are instances of~~\eqref{def:orig:inner:or-right}. 
  %     Thus there are derivations~$d_1''$ and~$d_2''$ such that
  %   }
  %     \[
  %   \MARK{
  %       d_1''\Vdash\<p'',\alpha,m>\step{n}\<p_1'',\alpha_1,m_1>
  %       \quad\text{and}\quad
  %       d_2''\Vdash\<p'',\alpha,m>\step{n}\<p_2'',\alpha_2,m_2>,
  %     }
  %     \]
  %   \MARK{
  %     for some~$p_1''$, $p_2''\in{P}$.  Since~$d_1''\prec{d_1}$
  %     and~$d_2''\prec{d_2}$, by induction hypothesis, $\alpha_1=\alpha_2$,
  %     $m_1=m_2$, and~$p_1''=p_2''$, which implies
  %   }
  %     \[
  %   \MARK{
  %       p_1=(\ceu{p'\Or{p_1''}})=(\ceu{p'\Or{p_2''}})=p_2.
  %     }
  %     \]
  %   \end{case}
  \end{case}
\end{proof}


\subsection{The reaction outer-step relation}
\label{sub:orig:outer}

From the previous inner-step relation we define an outer-step
relation~($\ostep{}$) that when necessary pops the event stack advances
blocked programs.  \TODO{Improve this description.}

\begin{definition}[label={def:orig:outer-step},name={Reaction outer-step}]
  \begin{alignat}{2}
    \label{def:orig:outer:advance}
    &\AXC{$\<p,\alpha,m>\step{n}\<p',\alpha',m'>$}
    \UIC{$\<p,\alpha,m>\ostep{n}\<p',\alpha',m'>$}
    \DP
    &&\quad\text{if~$\blocked(p,\alpha,n)=0$}
    \\[1\jot]
    %%
    \label{def:orig:outer:pop}
    &\hskip-.45em\<p,e\alpha,m>\ostep{n}\<p,\alpha,m>
    &&\quad\text{if~$\blocked(p,\alpha,n)=1$}
  \end{alignat}
\end{definition}

\begin{theorem}[label={thm:orig:det-outer},
  name={Determinism of the outer-step relation}]
  For all~$p$, $p_1$, $p_2\in{P}$, $\alpha$, $\alpha_1$, $\alpha_2\in{E^*}$,
  $m$, $m_1$, $m_2\in\mathcal{M}$, and~$n\in{N}$,
  \begin{gather*}
    \text{if}\quad\<p,\alpha,m>\ostep{n}\<p_1,\alpha_1,m_1>
    \quad\text{and}\quad
    \<p,\alpha,m>\ostep{n}\<p_2,\alpha_2,m_2>,\\
    \text{then}\quad\<p_1,\alpha_1,m_1>=\<p_2,\alpha_2,m_2>.
  \end{gather*}
\end{theorem}
\begin{proof}
  \TODO{By induction on the structure of derivations.}
\end{proof}

\begin{theorem}[label={thm:orig:term-outer},
  name={Termination of the outer-step relation}]
  For all~$p\in{P}$, $\alpha\in{E}$, and~$m\in\mathcal{M}$,
  if~$p\ne\ceu{\Skip},\ceu{\Attr{v}{a}},\ceu{\Break}$ then
  \[
    \exists{\delta\in\Delta}(\<p,\alpha,m>\ostep{n}\delta).
  \]
\end{theorem}
\begin{proof}
  \TODO{Directly from \Cref{lem:orig:inner-step-or-blocked}.}
\end{proof}


\subsection{The reaction relation}
\label{sub:orig:reaction}

From the reflexive-transitive closure of the outer-step
relation~($\ostep{\ast}$) we define the reaction
relation~$\react{}\subseteq\Delta\times(P\times\mathcal{M}\times{N})$, which
computes a full program reaction.  Given an initial configuration, the
reaction relation evaluates it until the event stack becomes empty.

\begin{definition}[label={def:orig:reaction},name={Reaction}]
  Let~$p$, $p'\in{P}$, $\alpha\in{E^*}$, $m$, $m'\in\mathcal{M}$.  Then
  \[
    \<p,\alpha,m>\react{n}\<p',m'>
    \quad\text{iff}\quad
    \<p,\alpha,m>\ostep\ast\<p',\nil,m'>.
  \]
\end{definition}

The next two theorems establish, respectively, that reactions are
deterministic and always terminate (for the nontrivial
programs~$p\ne\ceu{\Skip},\ceu{\Attr{v}{a}},\ceu{\Break}$).

\begin{theorem}[label={thm:orig:det-react},
  name={Determinism of the reaction relation}]
  For all~$p$, $p_1$, $p_2\in{P}$, $\alpha\in{E^*}$, $m$, $m_1$,
  $m_2\in\mathcal{M}$, and~$n\in{N}$,
  \begin{gather*}
    \text{if}\quad\<p,\alpha,m>\react{n}\<p_1,m_1>
    \quad\text{and}\quad
    \<p,\alpha,m>\react{n}\<p_2,m_2>,\\
    \text{then}\quad\<p_1,m_1>=\<p_2,m_2>.
  \end{gather*}
\end{theorem}
\begin{proof}
  \TODO{?}
\end{proof}

\begin{theorem}[label={thm:orig:term-react},
  name={Termination of the reaction relation}]
  For all~$p\in{P}$, $\alpha\in{E}$, and~$m\in\mathcal{M}$,
  if~$p\ne\ceu{\Skip},\ceu{\Attr{v}{a}},\ceu{\Break}$ then
  \[
    \<p,\alpha,m>\react{n}\<p',m'>,
  \]
  for some~$p'\in{P}$ and~$m'\in\mathcal{M}$.
\end{theorem}
\begin{proof}
  \TODO{?}
\end{proof}


\section{Big-step version of the original formulation}
\label{sec:big}

\TODO{Minha ideia aqui é fazer uma versão big-step da formulação original.
  E no final comparar as duas versões, i.e., mostrar que são equivalentes.}

\begin{definition}
  \TODO{Parcial e provavelmente incorreta.}

  \noindent\emph{Empty program}
  \begin{equation}
    \<\nil,\alpha,m,n>\leadsto\<\alpha,m,n>
  \end{equation}

  \noindent\emph{Assignment}
  \begin{equation}
    \<\ceu{\Attr{v}{a}},\alpha,m,n>\leadsto\<\alpha,m[v/\eval(a)],n>
  \end{equation}

  \noindent\emph{Conditionals}
  \begin{alignat}{2}
    &\AXC{$\<p_1,\alpha,m,n>\leadsto\<\alpha',m',n'>$}
    \UIC{$\<\ceu{\Ifelse{b}{p_1}{p_2}},\alpha,m,n>
      \leadsto\<\alpha',m',n'>$}
    \DP
    &&\quad\text{if~$\eval(b,m)=1$}\\
    %%
    &\AXC{$\<p_2,\alpha,m,n>\leadsto\<\alpha',m',n'>$}
    \UIC{$\<\ceu{\Ifelse{b}{p_1}{p_2}},\alpha,m,n>
      \leadsto\<\alpha',m',n'>$}
    \DP
    &&\quad\text{if~$\eval(b,m)=0$}
  \end{alignat}

  \noindent\emph{Await}
  \begin{alignat}{2}
    &\AXC{$\<\ceu{\Awaiting(e,n+1)},e\alpha,m,n>\leadsto\<\alpha',m',n'>$}
    \UIC{$\<\ceu{\Await(e)},\alpha,m,n>\leadsto\<\alpha',m',n'>$}
    \DP
    &&\\[1\jot]
    %%
    &\<\ceu{\Awaiting(e',n')},e\alpha,m,n>\leadsto\<\alpha,m,n>
    &&\quad\text{if~$e'=e$ and~$n'<n$}\\[1\jot]
    %%
    &\AXC{$\<\ceu{\Awaiting(e',n')},\alpha,m,n>\leadsto\<\alpha'',m'',n''>$}
    \UIC{$\<\ceu{\Awaiting(e',n')},e\alpha,m,n>\leadsto\<\alpha'',m'',n''>$}
    \DP
    &&\quad\text{if~$e'\ne{e}$ or~$n'\ge{n}$}
  \end{alignat}

  \noindent\emph{Emit}
  \begin{alignat}{2}
    &\AXC{$\<\ceu{\Emitting(\|\alpha|)},e\alpha,m,n>
      \leadsto\<\alpha',m',n'>$}
    \UIC{$\<\ceu{\Emit(e)},\alpha,m,n>\leadsto\<\alpha',m',n'>$}
    \DP
    &&\\[1\jot]
    %%
    &\<\ceu{\Emitting(n')},e\alpha,m,n>\leadsto\<\alpha,m,n>
    &&\quad\text{if~$\|e\alpha|={n'}$}\\[1\jot]
    %%
    &\AXC{$\<\ceu{\Emitting(n')},\alpha,m,n>\leadsto\<\alpha'',m'',n''>$}
    \UIC{$\<\ceu{\Emitting(n')},e\alpha,m,n>\leadsto\<\alpha'',m'',n''>$}
    \DP
    &&\quad\text{if~$\|e\alpha|\ne{n'}$}
  \end{alignat}
\end{definition}

\end{document}
